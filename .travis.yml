language: python

cache:
  pip: true
  directories:
  - "$HOME/.cache/pre-commit"

jobs:
  include:
  - python: '3.6'
  - python: '3.7'
  - python: '3.8'
    env: PRE_COMMIT=1
  fast_finish: true

dist: xenial
os: linux

install:
- pip install coverage coveralls
- test ! "$PRE_COMMIT" || pip install pre-commit
- pip install "mypy>=0.782"
- pip install -e .

script:
- test ! "$PRE_COMMIT" || pre-commit run --all-files
- mypy --python-version $TRAVIS_PYTHON_VERSION pysyncthru
- coverage run --source=pysyncthru setup.py test

after_success:
- coverage report
- coveralls

before_deploy:
- git config --local user.name "nielstron"
- export TRAVIS_TAG=release-$(cat setup.py | grep version= | cut -d "\"" -f 2)
- git tag $TRAVIS_TAG || echo "Tag already exists"

deploy:
  - provider: pypi
    on:
      branch: master
      python: '3.8'
    skip_existing: true
    username: nielstron
    password:
      secure: yh4UURTCp8JJ14AQ5bGeT9/IrddUEbIQD0ST+MgIG3IH2ii49Gss947TiYDkMcWd7tWFobrqVsDP8r6kwo9x7M/FDHqnFarclCD6PRzi3PYN8OUeRJpKpAXYYbqbRtUHxtS2lkK3mzyYyvr3eCT7TDLTyDO75bpyRifjKLsfARbT0CU9DBbLed305UgBnEUrwZH9dy7zYkCT+sto0F4LfdNhpbJAmT4IPRtngCgg9BEcdKxJaBZYOxQ4bsamDsu+8Ocwqe87GCnhnOIkxKqJ9ptkLKnOukvUwbCxlUZCZE39w31uzrW2Ml1/xXmjMxmSAstKjptdhSAFUeFG92pRufKUWZZI7DQK6NOfgP3HUz5pjwKJqn7hMREVl7Qa/IxPgEbDQ5HChmKrRMhRpfTHM9WfhiXy5Y9Yxcx2YH00dJYElw3LuEhXP+IhScBVtkZGmX8XxoVLYoxwm1/JL873zdsShv9ZCSgoe0cLFE7wAPlTdV2q9IQXd87YkaWuZtz6iOsKST+wKf2ergCuxCfXwEEQE9z7dswyfzLnPBxGVBXliv0M8avtRVOoiYFr21OAyJCMw4VMFfjWR0vJjzPiRh7tPMftWP9RGCvpqDmtZGLP6jhWIXGDDAyryj49L9lND8CgTJJv20nLftNrs2y3EEgLfYeicQXS5C0qzzzsPVI=
  - provider: releases
    cleanup: true
    overwrite: false
    on:
      branch: master
      python: '3.8'
      condition: "$TRAVIS_EVENT_TYPE = push"
    token:
      secure: UCdkdIOHZjSU/H6jLxEyiobJ4D44PnfSZE96qMaci1f8oVmYlq1Y9b+tfqD92ZeuMD9YwcOu5T106IKEtxJu8WUii1H8cDHN7ul1fvUvQan5b6o90Df+vLh3c3coj38lwDw4kxP5LsOCERMZ4OA5kM5sh11YiVhyYNyOYlBChFUeEUMRQkR3uu7pgGPEu7cZx7duRdr/3G3i0HKQUyHN3HRuqWQhQvhHgdrvUhEupc7KGsrn7KfQx/zPrCHZJZ1/wRvmGG/Yo8W0ZHXemWbubwI83Ho0VMdDKH2Nj+uNv+bZwGImGbhrG+SB7RwpynG8whKQCc5Mphr5r6LzOi6JbAMxJeIH/J/JsyZwe65EDcjPBKMuyrv6NDrmPiPmceLAN7idqEdw5J5NMcw9yhdMTxJNsUgSnSsHhaMW78R23MM/76jU3cew6D9d21h8aw1trcoOcJ0/h0q43OuSZ/uH045U4wMWD2mqEP94qdUg9vpkiw2dJ9FHs0F3kjfAze/m8VUQbhXxkXKvFBv/dcy/g6iG9lBYcXSOV+TFScuajTVRODDohN02OsQIqFt/5tUxDLmRzeJAPvOW7E7dxoeRfOj6l/6DIZ4SUY9vdXPYEqxbN27JE2nTPE6M6fGNRm6YfBRWL/ij0Zs5U+Ww6uS6c9rsXelXcZMqCFodwVbKlhE=
